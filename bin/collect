#!/usr/bin/env zsh

# Collect downloaded PNG images, optimize and put them into place.

here=$0:A:h
root=$here:h
images_dir=$root/images
svg_dir=$images_dir/svg
png_dir=$images_dir/png
downloads_dir=${DOWNLOADS_DIR:-$HOME/Downloads}
mkdir -p $png_dir

retval=0
pngs=()
for svg in $svg_dir/*.svg; do
    basename=${svg:t:r}@4x.png
    src=$downloads_dir/$basename
    dst=$png_dir/$basename
    [[ -f $src ]] || {
        echo "Error: ${(q-)src} not found." >&2
        retval=1
        continue
    }
    mv $src $dst
    pngs+=$dst
done
parallel optipng ::: $pngs
exit $retval
